<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			body { background-color: #000; margin: 0; overflow: hidden; font-family: Tahoma, Helvetica, Arial; }
			nav { position: absolute; top: 40%; text-align: center; opacity: 0.5; }
			nav:hover { opacity: 1; }
			#left { left: 40px; }
			#right { right: 40px; }
			a { outline: none; cursor: pointer; text-decoration: none; color: #fff; font-size: 18px; }
			#left .fa { color: green; display: block; }
			#right .fa { color: red; display: block; }
		</style>
		<link rel="stylesheet" href="./lib/font-awesome.css" type="text/css"/>
		<script src="./lib/3d-force-graph.min.js"></script>
		<script src="./lib/socket.io.js"></script>
        <script src="./NeuralNetwork.js"></script>
	</head>
	<body>
		<nav id="left"><a href="javascript:;" onclick="if (socket) { socket.emit('learn'); }"><i class="fa fa-check fa-5x"></i>GOOD ROBOT!</a></nav>
		<nav id="right"><a href="javascript:;" onclick="if (socket) { socket.emit('unlearn'); }"><i class="fa fa-times fa-5x"></i>BAD ROBOT!</a></nav>
		<div id="main"></div>
		<script>

            let graphData, network, socket = io();

            socket.on('connection', data => {
				console.log('connection', data);

				if (data) {
					network = new botbrain.NeuralNetwork(data);
					let inputNodes = network.channels.reduce((acc, c) => acc.concat(c), []);
					let outputNodes = network.drains.reduce((acc, c) => acc.concat(c), []);
					let nodes = network.nodes.map(node => ({ id: node.id, color: outputNodes.indexOf(node.id) + 1 ? '#ff0000' : (inputNodes.indexOf(node.id) + 1 ? '#0000ff' : undefined) }));
					let links = network.nodes.reduce((acc, n, i, arr) => acc.concat(n.synapses.filter(s => s.t).map(s => ({ source: n.id, target: s.t.id, opacity: s.w }))), []);
					console.log({ network, inputNodes })

					const Graph = ForceGraph3D()(document.getElementById('main'));

					Graph
						.warmupTicks(20)
						.cooldownTicks(150)
						.sphereColor(0x8fe7ff)
						//.highlightItems(true)
						.forceEngine('ngraph')
						.graphData({ nodes, links })
						.onReady(graph => graphData = graph.graphData)
						.onClick(x => console.log({x}));

					console.log({ graphData });
				}

            });

			socket.on('fire', id => {
				//console.log('fire', id);
				if (graphData) {
					let node = graphData.nodes[id];
					if (node && node.__sphere) {
						let material = node.__sphere.material;
						let oldColor = material.color;
						let fireColor = new THREE.Color(0xffffff);
						material.color = fireColor;
						material.opacity = 1;
						setTimeout(() => {
							material.color = oldColor;
							material.opacity = 0.6;
						}, 600);
					}
				}
			});

			socket.on('update', network => {
				// Update synapses
				console.log('update', { network, graphData });
				if (network && graphData) {
					let lines = graphData.links.map(l => l.__line);
					network.synapses.forEach((s, i) => lines[i].opacity = s.w);
				}
			});

		</script>
	</body>
</html>
