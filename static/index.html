<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { background-color: #000; margin: 0; overflow: hidden; font-family: Tahoma, Helvetica, Arial; user-select: none; }
    nav { position: absolute; top: 40%; text-align: center; opacity: 0.5; }
    nav:hover { opacity: 1; }
    #stats { position: absolute; width: 140px; color: white; font-weight: bold; padding: 20px; }
    #stats dl { position: relative; display: block; height: 13px; width: 100%; background: #333; margin: 0 0 10px; }
    #stats dd { position: absolute; width: 0%; height: 13px; background: #3f6674; margin: 0; }
    #stats dt { position: absolute; font-size: 10px; padding: 0 3px; }
    #info { width: 100%; position: absolute; color: white; padding: 20px; bottom: 0; }
    #info dl { display: block; float: left; width: 16%; text-align: center;}
    #info dd { display: block; font-size: 14pt; font-weight: bold; opacity: 0.8; margin: 0; }
    #info dt { display: block; font-size: 8pt; line-height: 15px; opacity: 0.5; }
    #left { left: 40px; }
    #right { right: 40px; }
    a { outline: none; cursor: pointer; text-decoration: none; color: #fff; font-size: 18px; }
    #left .fa { color: green; display: block; }
    #right .fa { color: red; display: block; }
  </style>
  <link href="./lib/font-awesome.css" rel="stylesheet" type="text/css">
  <script src="./lib/3d-force-graph.min.js">
  </script>
  <script src="./lib/socket.io.js">
  </script>
  <script src="./NeuralNetwork.js">
  </script>
  <title></title>
</head>
<body>
  <nav id="left">
    <a href="javascript:;" onclick="if (UI.socket) { UI.socket.emit('learn'); }"><i class="fa fa-check fa-5x"></i>GOOD ROBOT!</a>
  </nav>
  <nav id="right">
    <a href="javascript:;" onclick="if (UI.socket) { UI.socket.emit('unlearn'); }"><i class="fa fa-times fa-5x"></i>BAD ROBOT!</a>
  </nav>
  <section id="stats">
    <dl>
      <dd id="cpu">&nbsp;</dd>
      <dt>CPU</dt>
    </dl>
    <dl>
      <dd id="mem">&nbsp;</dd>
      <dt>MEM</dt>
    </dl>
  </section>
  <section id="info">
    <dl>
      <dd id="nodes">-</dd>
      <dt>nodes</dt>
    </dl>
    <dl>
      <dd id="synapses">-</dd>
      <dt>synapses</dt>
    </dl>
    <dl>
      <dd id="weight">--%</dd>
      <dt>weight</dt>
    </dl>
    <dl>
      <dd id="strength">--%</dd>
      <dt>strength</dt>
    </dl>
    <dl>
      <dd id="inputs">-</dd>
      <dt>inputs (<span style="font-size:10pt;color:blue">&#x2022</span>)</dt>
    </dl>
    <dl>
      <dd id="outputs">-</dd>
      <dt>outputs (<span style="font-size:10pt;color:red">&#x2022</span>)</dt>
    </dl>
  </section>
  <div id="main"></div>
  <script>

    var UI = {};
    
    UI.dom = ['main', 'cpu', 'mem', 'nodes', 'synapses', 'strength', 'weight', 'inputs', 'outputs']
      .reduce((acc, id) => {
      acc[id] = document.getElementById(id);
      return acc;
    }, {});

    UI.update = (network, stats) => { 
      if (network) {
        UI.dom.nodes.innerText = network.nodes.length;
        UI.dom.synapses.innerText = network.synapses.length;
        UI.dom.strength.innerText = Math.round(network.strength * 100) + '%';
        UI.dom.weight.innerText = Math.round(network.weight * 100) + '%';
        UI.dom.inputs.innerText = network.inputSites.length;
        UI.dom.outputs.innerText = network.outputSites.length;
      }
      if (stats) {
        UI.dom.cpu.style.width = Math.round(stats.cpu * 100) + '%';
        UI.dom.mem.style.width = Math.round(stats.mem * 100) + '%';
      }
    }

    UI.visualise = (network) => {
      let inputNodes = network.inputSites.reduce((acc, c) => acc.concat(c), []);
      let outputNodes = network.outputSites.reduce((acc, c) => acc.concat(c), []);
      let nodes = network.nodes.map(node => ({ id: node.id, color: outputNodes.indexOf(node) + 1 ? '#ff0000' : (inputNodes.indexOf(node) + 1 ? '#0000ff' : undefined) }));
      let links = network.nodes.reduce((acc, n, i, arr) => acc.concat(n.synapses.filter(s => s.target).map(s => ({ source: n.id, target: s.target.id, opacity: s.w }))), []);
      console.log({ network, inputNodes });

      const Graph = ForceGraph3D()(UI.dom.main);

      Graph
        .warmupTicks(120)
        .cooldownTicks(0)
        .sphereColor(0x8fe7ff)
      //.highlightItems(true)
        .forceEngine('ngraph')
        .graphData({ nodes, links })
        .nodeRelSize(5)
        .onReady(graph => UI.graphData = graph.graphData)
        .onClick(x => console.log('click', {x}));

      console.log({ graphData: UI.graphData });
    }

    (function() {

      UI.socket = io();

      UI.socket.on('connection', data => {
        console.log('connection', data);

        if (data) {
          let network = new botbrain.NeuralNetwork(data);
          UI.network = network; 
          UI.update(network);
          UI.visualise(network);
        }

      });

      UI.socket.on('fire', id => {
        //console.log('fire', id);
        if (UI.graphData) {
          let node = UI.graphData.nodes[id];
          let signalRecovery = 5000 / UI.network.opts.signalSpeed;
          if (node && node.__sphere) {
            let material = node.__sphere.material;
            let oldColor = material.color;
            let fireColor = new THREE.Color(0xffffff);
            material.color = fireColor;
            material.opacity = 1;
            setTimeout(() => {
              material.color = oldColor;
              material.opacity = 0.6;
            }, signalRecovery);
          }
        }
      });

      UI.socket.on('stats', stats => {
        console.log('stats', stats);
        UI.update(null, stats);
      });

      UI.socket.on('update', data => {
        // Update synapses
        const graphData = UI.graphData;
        console.log('update', { data, graphData });
        let network = new botbrain.NeuralNetwork(data);
        if (data && graphData) {
          let lines = graphData.links.map(l => l.__line);
          network.synapses.forEach((s, i) => lines[i].material.opacity = s.w);
        }
        UI.update(network);
      });

    })();

  </script>
</body>
</html>