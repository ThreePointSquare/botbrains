<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			body { background-color: #000; margin: 0; overflow: hidden; font-family: Tahoma, Helvetica, Arial; user-select: none; }
			nav { position: absolute; top: 40%; text-align: center; opacity: 0.5; }
			nav:hover { opacity: 1; }
			#stats { width: 100%; position: absolute; color: white; padding: 20px;}
			#stats dl { display: block; float: left; width: 16%; text-align: center;}
			#stats dt { display: block; font-size: 14pt; font-weight: bold; opacity: 0.8; }
			#stats dd { display: block; margin: 0; font-size: 8pt; line-height: 15px; opacity: 0.5; }
			#left { left: 40px; }
			#right { right: 40px; }
			a { outline: none; cursor: pointer; text-decoration: none; color: #fff; font-size: 18px; }
			#left .fa { color: green; display: block; }
			#right .fa { color: red; display: block; }
		</style>
		<link rel="stylesheet" href="./lib/font-awesome.css" type="text/css"/>
		<script src="./lib/3d-force-graph.min.js"></script>
		<script src="./lib/socket.io.js"></script>
        <script src="./NeuralNetwork.js"></script>
	</head>
	<body>
		<nav id="left"><a href="javascript:;" onclick="if (socket) { socket.emit('learn'); }"><i class="fa fa-check fa-5x"></i>GOOD ROBOT!</a></nav>
		<nav id="right"><a href="javascript:;" onclick="if (socket) { socket.emit('unlearn'); }"><i class="fa fa-times fa-5x"></i>BAD ROBOT!</a></nav>
		<section id="stats">
			<dl><dt id="nodes">-</dt>
				<dd>nodes</dd></dl>
			<dl><dt id="synapses">-</dt>
				<dd>synapses</dd></dl>
			<dl><dt id="weight">--%</dt>
				<dd>weight</dd></dl>
			<dl><dt id="strength">--%</dt>
				<dd>strength</dd></dl>
			<dl><dt id="inputs">-</dt>
				<dd>inputs (<span style="font-size:10pt;color:blue">&#x2022</span>)</dd></dl>
			<dl><dt id="outputs">-</dt>
				<dd>outputs (<span style="font-size:10pt;color:red">&#x2022</span>)</dd></dl>
		</section>
		<div id="main"></div>
		<script>

			let graphData, network, socket = io();
			dom = ['nodes', 'synapses', 'strength', 'weight', 'inputs', 'outputs']
				.reduce((acc, id) => {
					acc[id] = document.getElementById(id);
					return acc;
				}, {});

            socket.on('connection', data => {
				console.log('connection', data);

				if (data) {
					network = new botbrain.NeuralNetwork(data);
					let inputNodes = network.inputSites.reduce((acc, c) => acc.concat(c), []);
					let outputNodes = network.outputSites.reduce((acc, c) => acc.concat(c), []);
					let nodes = network.nodes.map(node => ({ id: node.id, color: outputNodes.indexOf(node) + 1 ? '#ff0000' : (inputNodes.indexOf(node) + 1 ? '#0000ff' : undefined) }));
					let links = network.nodes.reduce((acc, n, i, arr) => acc.concat(n.synapses.filter(s => s.target).map(s => ({ source: n.id, target: s.target.id, opacity: s.w }))), []);
					console.log({ network, inputNodes });

					const Graph = ForceGraph3D()(document.getElementById('main'));

					Graph
						.warmupTicks(120)
						.cooldownTicks(0)
						.sphereColor(0x8fe7ff)
						//.highlightItems(true)
						.forceEngine('ngraph')
						.graphData({ nodes, links })
						.onReady(graph => graphData = graph.graphData)
						.onClick(x => console.log({x}));

					console.log({ graphData });
				}

            });

			socket.on('fire', id => {
				//console.log('fire', id);
				if (graphData) {
					let node = graphData.nodes[id];
					let signalRecovery = 5000 / network.opts.signalSpeed;
					if (node && node.__sphere) {
						let material = node.__sphere.material;
						let oldColor = material.color;
						let fireColor = new THREE.Color(0xffffff);
						material.color = fireColor;
						material.opacity = 1;
						setTimeout(() => {
							material.color = oldColor;
							material.opacity = 0.6;
						}, signalRecovery);
					}
				}
			});

			socket.on('update', data => {
				// Update synapses
				console.log('update', { data, graphData });
				if (data && graphData) {
					let lines = graphData.links.map(l => l.__line);
					let newNetwork = new botbrain.NeuralNetwork(data);
					dom.nodes.innerText = newNetwork.nodes.length;
					dom.synapses.innerText = newNetwork.synapses.length;
					dom.strength.innerText = Math.round(newNetwork.strength * 100) + '%';
					dom.weight.innerText = Math.round(newNetwork.weight * 100) + '%';
					dom.inputs.innerText = newNetwork.inputSites.length;
					dom.outputs.innerText = newNetwork.outputSites.length;
					newNetwork.synapses.forEach((s, i) => lines[i].material.opacity = s.w);
				}
			});

		</script>
	</body>
</html>
